# Semantic Segmentation

[//]: # (Image References)

[image1]: img/loss.png "Loss chart"
[image21]: img/um_000001_b.png "Original graph"
[image22]: img/um_000001_f.png "Freezed graph"
[image23]: img/um_000001_o.png "Optimized graph"
[image24]: img/um_000001_e.png "Quantitized graph"

## Training

The hyperparameters used for training are:

    keep_prob: 0.5
    learning_rate: 0.0001
    epochs: 20
    batch_size: 16


![chart][image1]

##Optimzations
After training network was saved and several optimization techniques was applied to the graph. Original network contained 134271436 params, 402814310 vars and 1866 operations.

### 1. Freezing graph
In first step graph was freezed:
1. Variables converts  into constants 
2. Unnecessary nodes related to training are removed
3. The model can be contained entirely in one protobuf file (weights and graph definition)
4. Simplified graph structure

`~/tensorflow/bazel-bin/tensorflow/python/tools/freeze_graph --input_graph=model_.pb --input_binary=true --input_checkpoint=./model.ckpt --output_graph=out.pb --output_node_names=adam_logit`

Now network contains 0 params, 0 vars and 245 operations.

### 2. Optimizing for inference
Next step was apllied optimizing for inference. It does:
1. Removes training-specific and debug-specific nodes
2. Fuses common operations
3. Removes entire sections of the graph that are never reached

`~/tensorflow/bazel-bin/tensorflow/python/tools/optimize_for_inference --input=frozen_graph.pb --output=optimized_graph.pb --frozen_graph=True --input_names=image_input --output_names=adam_logit`

Only 200 operations was left in the graph
### 3. Quantization conversion
Then graph was converted to perform 8-bit calculations. 

`~/tensorflow/bazel-bin/tensorflow/tools/graph_transforms/transform_graph --in_graph=frozen_graph.pb --out_graph=eightbit_graph.pb --inputs=image_input --outputs=adam_logit --transforms='
add_default_attributes
remove_nodes(op=Identity, op=CheckNumerics)
fold_constants(ignore_errors=true)
fold_batch_norms
fold_old_batch_norms
fuse_resize_and_conv
quantize_weights
quantize_nodes
strip_unused_nodes
sort_by_execution_order'
`

After this operation probuf file noticible lost size. While original, frozen and optimized file have size around 530 Mb, converted one has size 130 Mb. But amount of operation increased - now graph has 407 operations.

## Comparison of results

I generated images for all 4 graphs. And while we don't see any difference between images generated by original, frozen and optimized graph there are noticible difference for converted graph. So this operation should be performed with caution. 

Original:

![image21][image21]

Frozen graph:

![image22][image22]

Optimized for inference:

![image23][image23]

8-bit graph:

![image24][image24]

### Introduction
In this project, you'll label the pixels of a road in images using a Fully Convolutional Network (FCN).

### Setup
##### Frameworks and Packages
Make sure you have the following is installed:
 - [Python 3](https://www.python.org/)
 - [TensorFlow](https://www.tensorflow.org/)
 - [NumPy](http://www.numpy.org/)
 - [SciPy](https://www.scipy.org/)
##### Dataset
Download the [Kitti Road dataset](http://www.cvlibs.net/datasets/kitti/eval_road.php) from [here](http://www.cvlibs.net/download.php?file=data_road.zip).  Extract the dataset in the `data` folder.  This will create the folder `data_road` with all the training a test images.

### Start
##### Implement
Implement the code in the `main.py` module indicated by the "TODO" comments.
The comments indicated with "OPTIONAL" tag are not required to complete.
##### Run
Run the following command to run the project:
```
python main.py
```
**Note** If running this in Jupyter Notebook system messages, such as those regarding test status, may appear in the terminal rather than the notebook.

### Submission
1. Ensure you've passed all the unit tests.
2. Ensure you pass all points on [the rubric](https://review.udacity.com/#!/rubrics/989/view).
3. Submit the following in a zip file.
 - `helper.py`
 - `main.py`
 - `project_tests.py`
 - Newest inference images from `runs` folder
 
 ## How to write a README
A well written README file can enhance your project and portfolio.  Develop your abilities to create professional README files by completing [this free course](https://www.udacity.com/course/writing-readmes--ud777).
